<html>
<head>
<title>Spectrograms</title>
<style>

.chart rect {
    stroke: black;
}

.chart { 
    padding: 10px;
}

.graph-holder { 
    float:left;
    height: 200px;
    width: 50%;
}

</style>
</head>

<body>
    <h1>Pitch Detector</h1>

    <p>Notes are being printed to console.</p>

    <div id="pcm" class="graph-holder">
        <h2>PCM</h2>
    </div> 
    <div id="fft" class="graph-holder">
        <h2>FFT</h2>
        <h3>Peak: <span id="peak"></span></h3>
    </div> 

</body>

<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="js/lib/dsp.js" type="text/javascript"></script>
<script src="js/BarGraph.js" type="text/javascript"></script>
<script src="js/PitchDetector.js" type="text/javascript"></script>
<script src="js/NoteSnapper.js"></script>
<script type="text/javascript">

var pcmGraph = new BarGraph('#pcm', .1);
var fftGraph = new BarGraph('#fft', .01);

if (!navigator.getUserMedia) {
    navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
}

if (navigator.getUserMedia) {
    navigator.getUserMedia({audio: true}, success, function(e) { alert('boo'); });
} else {
    alert('not supported');
}

//needed map for float32Array, this is fastest implmentation, bizarrely.
Float32Array.prototype.evalMap = function(f) {
    var body = f.toString().replace(/function\s*\(x\)\s*\{\s*return /m, '').slice(0, -1);
    var worker = eval('(function (src,dst){ for (var i = 0, l = src.length; i < l; i++) { var x = src[i]; dst[i] = ' + body + '}})');
    var dst = new Float32Array(this.length);
    worker(this, dst);
    return dst;
};

var bufferSize = 2048;

var findPeak = function(sampleRate, data) {
    var peak = -1;
    var peakIndex = -1;
    var bucketFreq = sampleRate / bufferSize;
    var sum = 0;

    for(var i = 0; i < data.length; i++) {
            sum += data[i];
            if (data[i] > peak) {
                peak = data[i];
                peakIndex = i;
            }
    };

    return peakIndex * bucketFreq;
};

window.addEventListener('noteEvent', function(e) { console.log(e.detail); });

function success(e) {
    console.log('success');
    audioContext = window.AudioContext || window.webkitAudioContext;
    context = new audioContext();
    volume = context.createGain();
    audioInput = context.createMediaStreamSource(e);
    recorder = context.createJavaScriptNode(bufferSize,2,2);
    var fft = new RFFT(bufferSize, 44100);
    var peakSpan = document.getElementById('peak');
    var pitcher = new AudioInput.PitchDetector();

    audioInput.connect(volume);
    volume.connect(recorder);
    recorder.connect(context.destination);

    recorder.onaudioprocess = function(stream) {
        var raw = stream.inputBuffer.getChannelData(0);
        pcmGraph.update(raw);


        fft.forward(raw);
        fftGraph.update(fft.spectrum);
        var peak = findPeak(44100, fft.spectrum);
        peakSpan.innerHTML = peak;

        pitcher.process(raw,fft.spectrum);
    }
}

</script>
</html>
